<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Phượt Dak Lak → Sài Gòn</title>
  <style>
    :root {
      --bg: #0f1419;
      --card: #1a2332;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      --radius: 12px;
      --safe-top: env(safe-area-inset-top, 0);
      --safe-bottom: env(safe-area-inset-bottom, 0);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
      -webkit-text-size-adjust: 100%;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: calc(16px + var(--safe-bottom));
    }

    header {
      text-align: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    h1 {
      font-size: 1.35rem;
      font-weight: 700;
      margin: 0;
      color: var(--text);
    }

    .status {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .status.gps-ok { color: var(--success); }
    .status.gps-error { color: var(--danger); }
    .status.gps-pending { color: var(--warning); }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      margin-top: 16px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .block-name {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .block-text {
      font-size: 1.05rem;
      line-height: 1.55;
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .block-text.long {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      color: var(--muted);
    }

    .toggle-detail {
      display: inline-block;
      margin-top: 10px;
      font-size: 0.95rem;
      color: var(--accent);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 0;
      text-decoration: underline;
    }

    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      min-width: 140px;
      padding: 14px 20px;
      font-size: 1.05rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .info-line {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 1rem;
    }

    .scroll-wrap {
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .test-card {
      border-color: var(--warning);
      background: rgba(210, 153, 34, 0.08);
    }
    .test-card label {
      display: block;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .test-card input {
      width: 100%;
      padding: 10px 12px;
      font-size: 1rem;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    .test-card input::placeholder { color: var(--muted); opacity: 0.7; }
    .test-card .btn-apply {
      margin-top: 8px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Phượt Dak Lak → Sài Gòn</h1>
      <p class="status gps-pending" id="status">Nhấn "Bật âm thanh" rồi cho phép GPS</p>
    </header>

    <div class="actions">
      <button type="button" class="btn btn-primary" id="btnAudio">Bật âm thanh</button>
      <button type="button" class="btn btn-secondary" id="btnFetchPosition">Lấy vị trí</button>
      <button type="button" class="btn btn-secondary" id="btnReread" disabled>Đọc lại</button>
      <button type="button" class="btn btn-secondary" id="btnReadDetail" disabled style="display: none;">Đọc chi tiết</button>
    </div>

    <div class="card test-card" id="cardTestMode" style="display: none;">
      <strong>Chế độ test</strong>
      <p style="font-size: 0.9rem; color: var(--muted); margin: 8px 0 12px;">Nhập tọa độ <code>lat, lon</code> (ví dụ: 12.866653, 108.2558594)</p>
      <label for="testGps">lat, lon</label>
      <input type="text" id="testGps" placeholder="12.866653, 108.2558594" inputmode="decimal" />
      <button type="button" class="btn btn-primary btn-apply" id="btnApplyTest">Áp dụng tọa độ</button>
    </div>

    <div class="card" id="cardBlock">
      <div id="blockContent" class="scroll-wrap">
        <p class="empty-state" id="emptyState">Đang lấy vị trí... Sau khi có GPS, block hiện tại sẽ hiển thị ở đây.</p>
        <div id="blockDetail" style="display: none;">
          <div class="block-name" id="blockName"></div>
          <p class="block-text" id="shortText"></p>
          <button type="button" class="toggle-detail" id="toggleDetail">Xem chi tiết</button>
          <div class="block-text long" id="longText" style="display: none;"></div>
          <p class="info-line" id="infoLine"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- data.js (BLOCKS) → route.js (ROUTE từ geojson) → map-matching -->
  <script src="./data.js"></script>
  <script src="./route.js"></script>
  <script src="./map-matching.js"></script>
  <script>
    (function () {
      "use strict";

      // --- Cấu hình ---
      var WATCH_OPTIONS = {
        enableHighAccuracy: true,
        maximumAge: 60000,  // Cho phép dùng vị trí cache ≤ 1 phút (desktop thường chỉ có network location)
        timeout: 60000      // 60s (desktop/macOS network location có thể rất chậm)
      };
      var GPS_TIMEOUT_ERROR_AFTER = 3;

      // --- State ---
      var testMode = (function () {
        var p = typeof window !== "undefined" && window.location && window.location.search;
        return p && (p.indexOf("test=1") >= 0 || p.indexOf("test=true") >= 0);
      })();
      var currentBlock = null;
      var lastBlockId = null;
      var audioEnabled = false;
      var watchId = null;
      var gpsTimeoutCount = 0;

      // --- DOM ---
      var statusEl = document.getElementById("status");
      var cardTestMode = document.getElementById("cardTestMode");
      var testGpsEl = document.getElementById("testGps");
      var btnApplyTest = document.getElementById("btnApplyTest");
      var emptyStateEl = document.getElementById("emptyState");
      var blockDetailEl = document.getElementById("blockDetail");
      var blockNameEl = document.getElementById("blockName");
      var shortTextEl = document.getElementById("shortText");
      var longTextEl = document.getElementById("longText");
      var toggleDetailBtn = document.getElementById("toggleDetail");
      var infoLineEl = document.getElementById("infoLine");
      var btnAudio = document.getElementById("btnAudio");
      var btnFetchPosition = document.getElementById("btnFetchPosition");
      var btnReread = document.getElementById("btnReread");
      var btnReadDetail = document.getElementById("btnReadDetail");

      /**
       * Tạo nội dung chữ từ block.depth_info (history, geography, people_profession, comparison)
       */
      function buildDepthText(depthInfo) {
        if (!depthInfo || typeof depthInfo !== "object") return "";
        var parts = [];
        if (depthInfo.history) parts.push("Lịch sử: " + depthInfo.history);
        if (depthInfo.geography) parts.push("Địa lý: " + depthInfo.geography);
        if (depthInfo.people_profession) parts.push("Con người và nghề nghiệp: " + depthInfo.people_profession);
        if (depthInfo.comparison) parts.push("So sánh: " + depthInfo.comparison);
        return parts.join("\n\n");
      }

      /**
       * Cập nhật UI cho một block (data.js: id, name, region, info, km_start, km_end, depth_info)
       */
      function renderBlock(block, traveledKm) {
        if (!block) return;

        emptyStateEl.style.display = "none";
        blockDetailEl.style.display = "block";

        blockNameEl.textContent = (block.id ? block.id + " · " : "") + (block.name || "") + ", " + (block.region || "");
        shortTextEl.textContent = block.info || "";
        var depthText = buildDepthText(block.depth_info);
        longTextEl.textContent = depthText;
        if (depthText) {
          longTextEl.style.display = "none";
          toggleDetailBtn.style.display = "inline-block";
          toggleDetailBtn.textContent = "Xem chi tiết";
        } else {
          longTextEl.style.display = "none";
          toggleDetailBtn.style.display = "none";
        }

        var kmText = traveledKm != null ? "Đã đi ~" + traveledKm.toFixed(1) + " km · " : "";
        var range = window.MapMatcher && window.MapMatcher.getBlockKmRange(block);
        var rangeStr = range ? "Đoạn " + range.start_km.toFixed(1) + " – " + range.end_km.toFixed(1) + " km" : "";
        infoLineEl.textContent = kmText + rangeStr;
      }

      /**
       * Gắn Media Session để giọng đọc hiện như media trên màn hình khóa / Control Center (iPhone), có thể bật/tắt từ ngoài.
       */
      function setupMediaSession() {
        if (!navigator.mediaSession) return;
        navigator.mediaSession.setActionHandler("play", function () {
          if (window.speechSynthesis) window.speechSynthesis.resume();
          navigator.mediaSession.playbackState = "playing";
        });
        navigator.mediaSession.setActionHandler("pause", function () {
          if (window.speechSynthesis) window.speechSynthesis.pause();
          navigator.mediaSession.playbackState = "paused";
        });
        navigator.mediaSession.setActionHandler("stop", function () {
          if (window.speechSynthesis) window.speechSynthesis.cancel();
          navigator.mediaSession.playbackState = "none";
        });
      }

      /**
       * Đọc nội dung bằng speechSynthesis (short hoặc full).
       * mediaTitle: tùy chọn, hiện trên màn hình khóa / Control Center (Media Session).
       */
      function speakText(text, onEnd, mediaTitle) {
        if (!text || !window.speechSynthesis) {
          if (onEnd) onEnd();
          return;
        }
        window.speechSynthesis.cancel();
        if (navigator.mediaSession && typeof MediaMetadata !== "undefined") {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: mediaTitle || "Phượt Dak Lak → Sài Gòn",
            artist: "Thông tin tuyến đường"
          });
          navigator.mediaSession.playbackState = "playing";
        }
        var u = new SpeechSynthesisUtterance(text);
        u.lang = "vi-VN";
        u.rate = 0.95;
        u.onend = function () {
          if (navigator.mediaSession) navigator.mediaSession.playbackState = "none";
          if (onEnd) onEnd();
        };
        u.onpause = function () {
          if (navigator.mediaSession) navigator.mediaSession.playbackState = "paused";
        };
        u.onresume = function () {
          if (navigator.mediaSession) navigator.mediaSession.playbackState = "playing";
        };
        u.onerror = function () {
          if (navigator.mediaSession) navigator.mediaSession.playbackState = "none";
        };
        window.speechSynthesis.speak(u);
      }

      /**
       * Tạo toàn bộ nội dung đọc khi chuyển vùng: title → info → depth_info
       */
      function getBlockFullSpeechText(block) {
        if (!block) return "";
        var title = (block.id ? block.id + " · " : "") + (block.name || "") + ", " + (block.region || "");
        var parts = [title];
        if (block.info) parts.push(block.info);
        var depthText = buildDepthText(block.depth_info);
        if (depthText) parts.push(depthText);
        return parts.join(". ");
      }

      /**
       * Xử lý khi có vị trí mới: map-matching theo ROUTE → traveled_km → block, cập nhật UI + audio
       */
      function onPositionUpdate(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;
        gpsTimeoutCount = 0;
        console.log("[GPS] position", lat.toFixed(5), lon.toFixed(5));

        if (!window.MapMatcher || !window.ROUTE || !window.BLOCKS) {
          setStatus("Thiếu tuyến (geojson) hoặc BLOCKS.", "gps-error");
          return;
        }

        var traveledKm = window.MapMatcher.getTraveledKM(lat, lon);
        var block = window.MapMatcher.getCurrentBlock(traveledKm);

        if (block && block.id !== lastBlockId) {
          lastBlockId = block.id;
          currentBlock = block;
          if (audioEnabled) {
            var fullText = getBlockFullSpeechText(block);
            var title = (block.id ? block.id + " · " : "") + (block.name || "");
            if (fullText) speakText(fullText, undefined, title);
          }
        } else if (block) {
          currentBlock = block;
        } else if (window.BLOCKS && window.BLOCKS.length) {
          currentBlock = window.BLOCKS[0];
        }

        var now = new Date();
        var timeStr = now.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
        var statusMsg = "Đã lấy vị trí lúc " + timeStr + " — " + lat.toFixed(5) + ", " + lon.toFixed(5);
        var blockToRender = currentBlock;
        var kmToRender = traveledKm;
        // Delay + rAF + force reflow: Chrome thường không repaint ngay trong callback geolocation
        setTimeout(function () {
          requestAnimationFrame(function () {
            if (blockToRender) renderBlock(blockToRender, kmToRender);
            setStatus(statusMsg, "gps-ok");
            void statusEl.offsetHeight; // force reflow để ép repaint
          });
        }, 50);
      }

      function onPositionError(err) {
        console.warn("[GPS] onPositionError", err.code, err.message);
        if (err.code === 3) {
          gpsTimeoutCount += 1;
          if (gpsTimeoutCount >= GPS_TIMEOUT_ERROR_AFTER) {
            setStatus("Lỗi GPS: Hết thời gian chờ. Kiểm tra quyền vị trí hoặc dùng ?test=1 để thử.", "gps-error");
          } else {
            setStatus("Đang lấy vị trí... (" + gpsTimeoutCount + "/" + GPS_TIMEOUT_ERROR_AFTER + ")", "gps-pending");
          }
          return;
        }
        var msg = "Lỗi GPS: ";
        if (err.code === 1) msg += "Từ chối quyền.";
        else if (err.code === 2) msg += "Không lấy được vị trí.";
        else msg += err.message || "Không xác định.";
        setStatus(msg, "gps-error");
      }

      function setStatus(text, className) {
        statusEl.textContent = text;
        statusEl.className = "status " + (className || "");
      }

      /**
       * Bật theo dõi GPS (watchPosition, bắt đầu từ user gesture).
       */
      function startWatching() {
        if (watchId != null) return;
        if (!navigator.geolocation) {
          setStatus("Trình duyệt không hỗ trợ GPS.", "gps-error");
          return;
        }
        setStatus("Đang lấy vị trí...", "gps-pending");
        watchId = navigator.geolocation.watchPosition(onPositionUpdate, onPositionError, WATCH_OPTIONS);
      }

      /**
       * Fetch vị trí chủ động (user bấm nút — user gesture nên không bị violation).
       */
      function fetchPosition() {
        if (!navigator.geolocation) {
          setStatus("Trình duyệt không hỗ trợ GPS.", "gps-error");
          return;
        }
        setStatus("Đang lấy vị trí...", "gps-pending");
        navigator.geolocation.getCurrentPosition(onPositionUpdate, onPositionError, WATCH_OPTIONS);
      }

      // --- Test mode: hiện card nhập tọa độ, prefill đầu tuyến nếu có
      if (testMode && cardTestMode) {
        cardTestMode.style.display = "block";
        if (window.ROUTE && window.ROUTE.length && testGpsEl) {
          testGpsEl.placeholder = String(window.ROUTE[0].lat) + ", " + String(window.ROUTE[0].lon);
        }
        setStatus("Chế độ test: nhập lat, lon và nhấn \"Áp dụng tọa độ\".", "gps-pending");
      }

      btnApplyTest.addEventListener("click", function () {
        var raw = (testGpsEl.value.trim() || (testGpsEl.placeholder || "")).split(",");
        var latStr = raw[0] ? raw[0].trim() : "";
        var lonStr = raw[1] ? raw[1].trim() : "";
        var lat = parseFloat(latStr, 10);
        var lon = parseFloat(lonStr, 10);
        if (Number.isNaN(lat) || Number.isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
          setStatus("Nhập đúng dạng lat, lon (ví dụ: 12.866653, 108.2558594).", "gps-error");
          return;
        }
        onPositionUpdate({ coords: { latitude: lat, longitude: lon } });
        setStatus("Đã áp dụng tọa độ test.", "gps-ok");
      });

      // --- Nút "Bật âm thanh": kích hoạt audio (Chrome iOS cần user gesture) + xin GPS
      // Trên iOS, giọng nói chỉ chạy nếu lần đầu phát nằm trong user gesture. Phát câu mồi ngay trong click để "mở khóa", sau đó auto-đọc từ callback GPS mới có thể chạy.
      btnAudio.addEventListener("click", function () {
        if (!window.speechSynthesis) {
          setStatus("Trình duyệt không hỗ trợ đọc tiếng nói.", "gps-error");
          return;
        }
        audioEnabled = true;
        setupMediaSession();
        btnAudio.textContent = "Đã bật âm thanh";
        btnAudio.disabled = true;
        // Câu mồi ngay trong click → iOS coi là user gesture, cho phép các lần speak sau (từ callback GPS)
        speakText("Âm thanh đã bật. Đang lấy vị trí.", undefined, "Phượt Dak Lak → Sài Gòn");
        if (testMode) {
          setStatus("Chế độ test: nhập tọa độ và nhấn \"Áp dụng tọa độ\".", "gps-pending");
          return;
        }
        setStatus("Đang xin quyền GPS...", "gps-pending");
        startWatching();
      });

      if (btnFetchPosition) btnFetchPosition.addEventListener("click", fetchPosition);

      btnReread.addEventListener("click", function () {
        if (!currentBlock) return;
        var text = currentBlock.info || "";
        var title = (currentBlock.id ? currentBlock.id + " · " : "") + (currentBlock.name || "");
        if (text) speakText(text, undefined, title);
      });

      btnReadDetail.addEventListener("click", function () {
        if (!currentBlock || !currentBlock.depth_info) return;
        var text = buildDepthText(currentBlock.depth_info);
        var title = (currentBlock.id ? currentBlock.id + " · " : "") + (currentBlock.name || "") + " (chi tiết)";
        if (text) speakText(text, undefined, title);
      });

      toggleDetailBtn.addEventListener("click", function () {
        var show = longTextEl.style.display !== "none";
        longTextEl.style.display = show ? "none" : "block";
        toggleDetailBtn.textContent = show ? "Xem chi tiết" : "Thu gọn";
      });

      // Cập nhật nút Đọc lại / Đọc chi tiết theo block hiện tại
      function updateReadButtons() {
        btnReread.disabled = !currentBlock;
        if (btnReadDetail) {
          var hasDepth = currentBlock && currentBlock.depth_info;
          btnReadDetail.style.display = hasDepth ? "inline-block" : "none";
          btnReadDetail.disabled = !hasDepth;
        }
      }

      var origRender = renderBlock;
      renderBlock = function (block) {
        origRender.apply(null, arguments);
        updateReadButtons();
      };
      updateReadButtons();
    })();
  </script>
</body>
</html>
